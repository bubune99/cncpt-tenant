{"version":3,"sources":["../src/hooks/use-auth.ts","../src/hooks/use-media-upload.ts"],"sourcesContent":["\"use client\";\n\nimport { useUser } from \"@stackframe/stack\";\nimport { useState, useEffect, useRef } from \"react\";\nimport { useRouter } from \"next/navigation\";\n\ninterface DbUser {\n  id: string;\n  stackAuthId: string;\n  email: string;\n  name: string | null;\n  role: string;\n}\n\nexport function useAuth() {\n  const stackUser = useUser();\n  const router = useRouter();\n  const [authChecked, setAuthChecked] = useState(false);\n  const [dbUser, setDbUser] = useState<DbUser | null>(null);\n  const [syncError, setSyncError] = useState<string | null>(null);\n  const syncAttemptedRef = useRef(false);\n\n  // Sync Stack Auth user to database\n  useEffect(() => {\n    if (stackUser && !syncAttemptedRef.current) {\n      syncAttemptedRef.current = true;\n\n      const syncUser = async () => {\n        try {\n          const response = await fetch(\"/api/auth/sync\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({\n              stackAuthId: stackUser.id,\n              email: stackUser.primaryEmail,\n              name: stackUser.displayName,\n              avatar: stackUser.profileImageUrl,\n            }),\n          });\n\n          if (response.ok) {\n            const data = await response.json();\n            setDbUser(data.user);\n          } else {\n            const error = await response.json();\n            console.error(\"User sync failed:\", error);\n            setSyncError(error.error || \"Sync failed\");\n          }\n        } catch (error) {\n          console.error(\"User sync error:\", error);\n          setSyncError(\"Network error during sync\");\n        }\n      };\n\n      syncUser();\n    }\n  }, [stackUser]);\n\n  useEffect(() => {\n    if (stackUser !== undefined) {\n      setAuthChecked(true);\n    }\n    // Reset sync attempt when user changes\n    if (!stackUser) {\n      syncAttemptedRef.current = false;\n      setDbUser(null);\n      setSyncError(null);\n    }\n  }, [stackUser]);\n\n  return {\n    user: stackUser,\n    dbUser, // The synced database user with local ID\n    isLoading: stackUser === undefined,\n    isAuthenticated: !!stackUser,\n    authChecked,\n    syncError,\n    signOut: async () => {\n      try {\n        if (stackUser) {\n          await stackUser.signOut();\n        } else {\n          router.push('/handler/sign-out');\n        }\n      } catch (error) {\n        console.error('Sign out error:', error);\n        router.push('/handler/sign-out');\n      }\n    }\n  };\n}","'use client'\n\nimport { useState, useCallback } from 'react'\nimport type { UploadProgress } from '../lib/media/types'\n\ninterface UseMediaUploadOptions {\n  folderId?: string | null\n  onSuccess?: (media: any) => void\n  onError?: (error: string) => void\n}\n\nexport function useMediaUpload(options: UseMediaUploadOptions = {}) {\n  const [uploads, setUploads] = useState<Map<string, UploadProgress>>(new Map())\n  const [isUploading, setIsUploading] = useState(false)\n\n  const updateUpload = useCallback((id: string, updates: Partial<UploadProgress>) => {\n    setUploads((prev) => {\n      const newMap = new Map(prev)\n      const current = newMap.get(id)\n      if (current) {\n        newMap.set(id, { ...current, ...updates })\n      }\n      return newMap\n    })\n  }, [])\n\n  const uploadFile = useCallback(\n    async (file: File): Promise<any> => {\n      const uploadId = `${file.name}-${Date.now()}`\n\n      // Add to uploads\n      setUploads((prev) => {\n        const newMap = new Map(prev)\n        newMap.set(uploadId, {\n          id: uploadId,\n          filename: file.name,\n          progress: 0,\n          status: 'pending',\n          size: file.size,\n        })\n        return newMap\n      })\n\n      try {\n        updateUpload(uploadId, { status: 'uploading', progress: 10 })\n\n        // Step 1: Get presigned URL\n        const presignResponse = await fetch('/api/media', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            action: 'presign',\n            filename: file.name,\n            mimeType: file.type,\n            size: file.size,\n          }),\n        })\n\n        if (!presignResponse.ok) {\n          const error = await presignResponse.json()\n          throw new Error(error.error || 'Failed to get upload URL')\n        }\n\n        const presignData = await presignResponse.json()\n        updateUpload(uploadId, { progress: 30 })\n\n        // Step 2: Upload to storage\n        const uploadResponse = await fetch(presignData.uploadUrl, {\n          method: 'PUT',\n          body: file,\n          headers: {\n            'Content-Type': file.type,\n          },\n        })\n\n        if (!uploadResponse.ok) {\n          throw new Error('Failed to upload file')\n        }\n\n        updateUpload(uploadId, { progress: 70 })\n\n        // Step 3: Create media record\n        const completeResponse = await fetch('/api/media', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            action: 'complete',\n            filename: presignData.key.split('/').pop(),\n            originalName: file.name,\n            mimeType: file.type,\n            size: file.size,\n            url: presignData.publicUrl,\n            key: presignData.key,\n            bucket: presignData.bucket,\n            provider: presignData.provider,\n            folderId: options.folderId,\n          }),\n        })\n\n        if (!completeResponse.ok) {\n          const error = await completeResponse.json()\n          throw new Error(error.error || 'Failed to create media record')\n        }\n\n        const media = await completeResponse.json()\n\n        updateUpload(uploadId, {\n          status: 'complete',\n          progress: 100,\n          url: media.url,\n        })\n\n        options.onSuccess?.(media)\n        return media\n      } catch (error) {\n        const message = error instanceof Error ? error.message : 'Upload failed'\n        updateUpload(uploadId, {\n          status: 'error',\n          error: message,\n        })\n        options.onError?.(message)\n        throw error\n      }\n    },\n    [options, updateUpload]\n  )\n\n  const uploadFiles = useCallback(\n    async (files: FileList | File[]) => {\n      setIsUploading(true)\n\n      const fileArray = Array.from(files)\n      const results: any[] = []\n\n      for (const file of fileArray) {\n        try {\n          const media = await uploadFile(file)\n          results.push(media)\n        } catch (error) {\n          // Continue with other files\n        }\n      }\n\n      setIsUploading(false)\n      return results\n    },\n    [uploadFile]\n  )\n\n  const clearCompleted = useCallback(() => {\n    setUploads((prev) => {\n      const newMap = new Map(prev)\n      for (const [id, upload] of newMap) {\n        if (upload.status === 'complete' || upload.status === 'error') {\n          newMap.delete(id)\n        }\n      }\n      return newMap\n    })\n  }, [])\n\n  const clearAll = useCallback(() => {\n    setUploads(new Map())\n  }, [])\n\n  return {\n    uploads: Array.from(uploads.values()),\n    isUploading,\n    uploadFile,\n    uploadFiles,\n    clearCompleted,\n    clearAll,\n  }\n}\n"],"mappings":"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","names":["useState","useState"]}